# app/core/numerology_service.py
from __future__ import annotations

from datetime import datetime
from textwrap import dedent
from typing import Optional

from loguru import logger

from app.core.llm_client import chat
from app.core.llm_router import Feature
from app.core.numerology_math import calc_all

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–æ–¥–µ–ª–∏
SYSTEM = """
–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω—É–º–µ—Ä–æ–ª–æ–≥. –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –∫—Ä–∞—Ç–∫–æ –∏ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ.
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî Telegram HTML. –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–µ–≥–∏: <b>, <i>.
–ó–∞–ø—Ä–µ—â–µ–Ω—ã: <br>, <ul>, <ol>, <li>, <p>, <div>, —Ç–∞–±–ª–∏—Ü—ã, –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ç–µ–≥–∏.
–ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫–∏ –¥–µ–ª–∞–π –æ–±—ã—á–Ω—ã–º–∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ —Å—Ç—Ä–æ–∫–∏ \\n; –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ ‚Äî –æ–¥–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Ñ–æ—Ä–º—É–ª—ã, –∏–∑–≤–∏–Ω–µ–Ω–∏—è, –¥–∏—Å–∫–ª–µ–π–º–µ—Ä—ã –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
–ß–∏—Å–ª–∞ —É–∂–µ –ø–æ—Å—á–∏—Ç–∞–Ω—ã –Ω–∞ –±—ç–∫–µ–Ω–¥–µ ‚Äî –ò–°–ü–û–õ–¨–ó–£–ô –ò–• –ö–ê–ö –ï–°–¢–¨ –∏ –ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–π.
""".strip()

FOOTNOTE = (
    "\n\n<i>–í —Ä–∞—Å—á—ë—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–∏—Ñ–∞–≥–æ—Ä–µ–π—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã "
    "(–≤–∞—Ä–∏–∞–Ω—Ç —Å –æ—Ç–¥–µ–ª—å–Ω–æ–π –±—É–∫–≤–æ–π –Å, –ô=2, –¨/–™ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è).</i>"
)

def _user_prompt(full_name: str, birth_date: str, nums: dict, gender: Optional[str]) -> str:
    y = nums["year"]
    return dedent(f"""
    –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ (–ù–ï –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–π):
    ‚Ä¢ –§–ò–û: {full_name}
    ‚Ä¢ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: {birth_date}
    ‚Ä¢ –ü–æ–ª (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω): {gender or "-"}
    ‚Ä¢ –ß–∏—Å–ª–æ —Å—É–¥—å–±—ã: {nums["destiny_number"]}
    ‚Ä¢ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: {nums["birth_day_number"]}
    ‚Ä¢ –ß–∏—Å–ª–æ –¥—É—à–∏: {nums["soul_number"]}
    ‚Ä¢ –ß–∏—Å–ª–æ –ª–∏—á–Ω–æ—Å—Ç–∏: {nums["personality_number"]}
    ‚Ä¢ –ß–∏—Å–ª–æ –∏–º–µ–Ω–∏: {nums["name_number"]}
    ‚Ä¢ –õ–∏—á–Ω—ã–π –≥–æ–¥ ({y}): {nums["personal_year"]}

    –°—Ñ–æ—Ä–º–∏—Ä—É–π –æ—Ç–≤–µ—Ç –†–û–í–ù–û –ø–æ —à–∞–±–ª–æ–Ω—É (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ <b> –∏ <i>):

    <b>–ù—É–º–µ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å</b>
    {full_name} ‚Ä¢ {birth_date}

    üî¢ –ß–∏—Å–ª–æ —Å—É–¥—å–±—ã: {nums["destiny_number"]}
    1‚Äì2 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã (—Ö–∞—Ä–∞–∫—Ç–µ—Ä, –∑–∞–¥–∞—á–∏, —Ç–∏–ø–∏—á–Ω—ã–µ –≤—ã–∑–æ–≤—ã).

    üèõ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è: {nums["birth_day_number"]}{' (–º–∞—Å—Ç–µ—Ä-—á–∏—Å–ª–æ)' if nums['birth_day_number'] in (11,22,33) else ''}
    1‚Äì2 —Ñ—Ä–∞–∑—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –¥–Ω—è.

    üíú –ß–∏—Å–ª–æ –¥—É—à–∏: {nums["soul_number"]}
    1‚Äì2 —Ñ—Ä–∞–∑—ã –æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö/–º–æ—Ç–∏–≤–∞—Ü–∏–∏.

    ü™û –ß–∏—Å–ª–æ –ª–∏—á–Ω–æ—Å—Ç–∏: {nums["personality_number"]}
    1‚Äì2 —Ñ—Ä–∞–∑—ã –æ —Ç–æ–º, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫–∞ –≤–∏–¥—è—Ç –æ–∫—Ä—É–∂–∞—é—â–∏–µ.

    üß≠ –ß–∏—Å–ª–æ –∏–º–µ–Ω–∏: {nums["name_number"]}
    1‚Äì2 —Ñ—Ä–∞–∑—ã –æ–± –æ–±—â–µ–º –≤–µ–∫—Ç–æ—Ä–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

    üìÜ –õ–∏—á–Ω—ã–π –≥–æ–¥ ({y}): {nums["personal_year"]}
    1‚Äì2 —Ñ—Ä–∞–∑—ã –ø—Ä–æ —Ç–µ–º—É –≥–æ–¥–∞.

    üéØ –§–æ–∫—É—Å –Ω–∞ –º–µ—Å—è—Ü
    1. –∫–æ—Ä–æ—Ç–∫–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ;
    2. –∫–æ—Ä–æ—Ç–∫–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ;
    3. –∫–æ—Ä–æ—Ç–∫–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.

    –ò—Ç–æ–≥: –æ–¥–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ-–≤—ã–≤–æ–¥ –ø—Ä–æ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —á–∏—Å–µ–ª.
    """).strip()

def analyze_numerology(full_name: str, birth_date: str, gender: Optional[str] = None) -> str:
    nums = calc_all(full_name, birth_date)
    logger.info("[numerology] start name='{}' birth='{}' -> nums={}", full_name, birth_date, nums)

    messages = [
        {"role": "system", "content": SYSTEM},
        {"role": "user", "content": _user_prompt(full_name, birth_date, nums, gender)},
    ]
    text = chat(Feature.NUMEROLOGY, messages, temperature=0.2)
    return text.rstrip() + FOOTNOTE